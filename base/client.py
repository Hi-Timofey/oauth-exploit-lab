from distutils.command.build import build
from flask import Flask, g, redirect
import random
import string
import urllib

app = Flask(__name__)
state: str = None
access_token: str = None
scope: str = None

client = {
    'client_id': 'oauth-client-1',
    'client_secret': 'oauth-client-secret-1',
    'redirect_uris': ['http://localhost:10000/callback'],
    'scope': 'hoge+huga'
}
auth_server = {
    'authorization_endpoint': 'http://localhost:10001/authorize',
    'token_endpoint': 'http://localhost:10001/token'
}

def generate_randomstring(size: int):
    return ''.join(random.SystemRandom().choice(string.ascii_uppercase + string.digits) for _ in range(size))

def build_url(base: str, options: dict):
    pr = urllib.parse.urlparse(base)
    return urllib.parse.urlunparse(pr._replace(query=urllib.parse.urlencode(options, doseq=True)))

@app.route("/", methods=["GET"])
def index():
    return "ok"

@app.route("/authorize", methods=["GET"])
def authorize():
    access_token = None
    state = generate_randomstring(32)
    authorize_url: str = build_url(auth_server['authorization_endpoint'], {
        'response_type': 'code',
        'client_id': client['client_id'],
        'redirect_uri': client['redirect_uris'][0],
        'state': state,
        'scope': client['scope']
    })
    print('redirect to:', authorize_url)
    return redirect(authorize_url)

@app.route("/callback", methods=["GET"])
def callback():
    return "ok"

@app.route("/fetch_resource", methods=["GET"])
def fetch_resource():
    return "ok"

if __name__ == '__main__':
    app.run(host="0.0.0.0", port=10000)