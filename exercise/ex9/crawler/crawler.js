const puppeteer = require('puppeteer');

const base_url = "http://client:10000"
const browser_option = {
    headless: true,
    args: [
        '-wait-for-browser',
        '--no-sandbox', '--disable-gpu',
        '--js-flags="--noexpose_wasm"'
    ]
}

const wait = ms => new Promise(resolve => setTimeout(resolve, ms));

const visit = async(url) => {
    console.log(`[+] Visiting: ${url}`);

    const username = "tom";
    const password = "huga";

    const browser = await puppeteer.launch(browser_option);
    try {
        const page = await browser.newPage();

        await page.setRequestInterception(true);
        let redirect_url;
        page.on('request', (request) => {
            if (request.isNavigationRequest() && request.redirectChain().length !== 0) {
                redirect_url = request.url();
                request.abort();
            } else {
                request.continue();
            }
        });

        await page.goto(base_url + '/login', {timeout: 3000});
        await page.type('#name', username);
        await page.type('#password', password);
        await page.click('#tag-login');
        await wait(1000);
        
        const client = await page.target().createCDPSession();
        const cookies = (await client.send('Network.getAllCookies')).cookies;

        // OAuth dance
        await page.goto(base_url, {timeout: 3000});
        await page.click('#tag-get-token');
        await wait(1000);
        redirect_url = redirect_url.replace('localhost', 'auth_server');
        await page.setCookie({name: 'session', value: cookies[0].value, domain: 'auth_server'});
        await page.goto(redirect_url, {timeout: 3000});
        await page.click('#tag-approve');
        await wait(1000);
        redirect_url = redirect_url.replace('localhost', 'client');
        await page.goto(redirect_url, {timeout: 3000});
        await wait(1000);

        // Visit input url
        await page.goto(url, {timeout: 3000});
        await wait(3000);
        await page.close();
    } catch(e) {
        console.log("[-] " + e);
    }

    console.log(`[+] Crawler done`);
    await browser.close();
}

module.exports = { visit }