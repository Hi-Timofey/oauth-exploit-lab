# Exercise 4
This is an exercise that exploits the scope upgrade vulnerability. The goal is to upgrade the scope from the original.

## Setup
```
$ git clone https://github.com/melonattacker/oauth-exploit-lab.git
$ cd oauth-exploit-lab/exercise/ex4
$ docker-compose up -d
```
### URL
|  target  |  URL  |
| ---- | ---- |
|  client  |  `http://localhost:10000`  |

### Account
|  username  |  password  |
| ---- | ---- |
|  bob(attacker)  |  hoge  |

## Writeup

Looking at line 157 of authorizationServer/app.py, you can see that the scope can be respecified when issuing a token.
```:.py
    if request.form.get('scope') != None:
        cscope = request.form.get('scope')
    else:
        if len(code['scope']) > 0:
            cscope = ' '.join(code['scope'])

    insert_to_db({'access_token': access_token, 'token_type': 'Bearer', 'scope': cscope, 'name': code['user']})
```

Client receives scope from request parameter and sends it to authorization server.
```:.py
    payload = {
        'grant_type': 'authorization_code',
        'code': code,
        'redirect_uri': client['redirect_uris'][0],
        'scope': request.args.get('scope')
    }
    headers = {
        'Content-Type': 'application/x-www-form-urlencoded',
        'Authorization': 'Basic ' + encode_client_credentials(client['client_id'], client['client_secret'])
    }
    res = requests.post(auth_server['token_endpoint'], data=payload, headers=headers)
```

This makes it vulnerable to score upgrade vulnerability. To exploit this, an attacker respecifies scope when token is issued.

First login as bob(attacker), and click `Get OAuth Token` button. Click the `Approve` button on the approve screen and foward. Capture the request here and add the scope parameter(`hoge%20huga%20piyo`) to your query.

<img width="871" alt="スクリーンショット 2022-09-11 20 16 23" src="https://user-images.githubusercontent.com/41631269/189524504-43c020fc-5216-497d-a126-f8842fe23185.png">

And turn intercept off. Press the `Get Protected Resource` button and you will see that the scope has been added(`hoge,huga` to `hoge,huga,piyo`).

<img width="1175" alt="スクリーンショット 2022-09-11 20 20 39" src="https://user-images.githubusercontent.com/41631269/189524659-0a9594cc-0a66-439c-b334-3765bfaf2bf9.png">