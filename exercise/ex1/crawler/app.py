from os import access
from flask import Flask, request
from bs4 import BeautifulSoup
import requests

app = Flask(__name__)

@app.route("/", methods=["GET"])
def index():
    return """
        <form class="form" action="/visit" method="POST">
            <label>URL visited by victim: </label>
            <input type="text" id="url" name="url" value="">
            <button type="submit">submit</button>
        </form>
    """
    
@app.route("/visit", methods=["POST"])
def visit():
    # login as victim
    session = requests.session()
    payload = {'name': 'tom', 'password': 'huga'}
    res = session.post('http://client:10000/login', data=payload)
    
    # visit fishing url
    res = session.get(request.form.get('url'))
    soup = BeautifulSoup(res.text, features="html.parser")
    access_token = soup.span.string
    if not access_token:
        return "error happend"
    
    return f"""
        <p>The attacker's resource was tied to the victim's client account.</p>
        <p>Please visit below link as victim(tom).</p>
        <p>http://localhost:10000/fetch_resource?access_token={access_token}</p>
    """

if __name__ == '__main__':
    app.run(host="0.0.0.0", port=10003)