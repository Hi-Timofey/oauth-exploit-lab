from flask import Flask, request, Response
from tinydb import TinyDB, Query
import json

app = Flask(__name__)

db = TinyDB('../db.json')

resource = {
    'bob': {
        'name': 'Protected Resource for bob',
        'description': 'bob bob bob'   
    }, 
    'tom': {
        'name': 'Protected Resource for tom',
        'description': 'tom tom tom'   
    }
}

@app.route("/resource", methods=["POST"])
def get_resource():
    auth = request.headers.get("authorization")
    in_token = None
    if auth != None and auth.lower().find('bearer') == 0:
        in_token = auth[len("bearer "):]
    elif request.form != None and request.form.get('access_token') != None:
        in_token = request.form.get('access_token')
    elif request.args != None and request.args.get('access_token') != None:
        in_token = request.args.get('access_token')
    
    print('Incoming token: %s' % (in_token))
    
    Token = Query()
    res = db.search(Token.access_token == in_token)
    print(res)
    if len(res) > 0:
        print('We found a matching token: %s' % (in_token))
        return Response(response=json.dumps(resource.get(res[0]['name'])), status=200)
    else:
        print('No matching token was found.')
        return None, 401
        

if __name__ == '__main__':
    app.run(host="0.0.0.0", port=10002)