from os import access
from flask import Flask, request
from bs4 import BeautifulSoup
import requests

app = Flask(__name__)

@app.route("/", methods=["GET"])
def index():
    return """
        <form class="form" action="/visit" method="POST">
            <label>URL visited by victim: </label>
            <input type="text" id="url" name="url" value="">
            <button type="submit">submit</button>
        </form>
    """
    
@app.route("/visit", methods=["POST"])
def visit():
    # login as victim
    session = requests.session()
    payload = {'name': 'tom', 'password': 'huga'}
    res = session.post('http://client:10000/login', data=payload, allow_redirects=False)
    cookie = res.cookies
    print(cookie)
    
    # visit fishing url
    res = session.get(request.form.get('url'), cookies=dict(cookie))
    print(res.cookies)
    
    # approve request
    soup = BeautifulSoup(res.text, features="html.parser")
    payload = {'reqid': soup.input['value'], 'scope_hoge': 'on', 'scope_huga': 'on', 'approve': 'Approve'}
    session.post('http://auth_server:10001/approve', data=payload, cookies=dict(cookie))
    
    return "State and authorization code is sent to attacker's server."

if __name__ == '__main__':
    app.run(host="0.0.0.0", port=10003)